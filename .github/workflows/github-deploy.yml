name: 'Deploy Nugets'

on:

  push:
    branches: [ "main", "master", "develop" ]

  workflow_dispatch: # allows to run this workflow manually from the Actions tab


jobs:

  compile:
    uses: './.github/workflows/github-compile.yml' # reuse the compile workflow


  deploy: # inspired by https://stackoverflow.com/a/77663335/863651
    runs-on: 'macos-14'

    needs: 'compile'

    steps:

      - name: '‚¨áÔ∏è Download Artifacts'
        uses: 'actions/download-artifact@v3'
        with:
          name: 'nugets'
          path: 'Artifacts/'

      - name: 'üöÄ Publish to the Laerdal Nuget Server on Github' # https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-nuget-registry
        run: |
          dotnet                                                                       \
                  nuget                                                                \
                  push                                                                 \
                  --source "https://nuget.pkg.github.com/Laerdal-Medical/index.json"   \
                  --api-key "${{ secrets.scl_github_access_token }}"                   \
                  "Artifacts/**/*.nupkg"

      # todo   remove this once we fully transition over to the laerdal nuget server on github
      - name: 'üöÄ Publish to the Laerdal Private Nuget Server in Azure' # https://learn.microsoft.com/en-us/azure/devops/artifacts/quickstarts/github-actions?view=azure-devops
        run: |
          dotnet                                                           \
                  nuget                                                    \
                  push                                                     \
                  --source "https://pkgs.dev.azure.com/LaerdalMedical/_packaging/LaerdalNuGet/nuget/v3/index.json" \
                  --api-key "${{ secrets.scl_azure_artifacts_api_key }}"   \
                  "Artifacts/**/*.nupkg"
